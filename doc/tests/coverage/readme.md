# Отчёты о покрытии кода тестами

Отчёт о покрытии кода тестами отражает информацию о том, какой процент и количество **строк** кода были вызваны при выполнении тестов. **Метод** счиается покрытым на 100% если все его строки были выполнены. **Класс** считается покрытым на 100%, если все его методы покрыты на 100%.

Кроме количественных показателей можно так же увидеть какие конкретно строки были исполнены, а какие только проанализированы:
- исполненные строки отмечаются **зелёным** цветом,
- не исполненные, но проанализированные **красным**.

При формировании отчёта могут быть использованы как все тесты, так и только отдельные, либо группа тестов.

Ели тест вызывает метод, который в свою очередь вызывает другие методы, эти другие методы так же будут учтены при анализе и все их исполненные строки будут считаться покрытыми. Это поведение можно изменить для отдельных тестов, указывая для них аннотацию `@covers`. Она позволяет указывать конкретный класс либо метод, который будет учитываться при вычислении покрытия при запуске этого теста. Подробнее об использовании этой функции см. [в документации PHPUnit](https://docs.phpunit.de/en/7.5/code-coverage-analysis.html#specifying-covered-code-parts).

## Формирование отчёта в виде HTML-страниц
Подразумевается, что у вас создана ссылка `mic` для быстрого вызова скрипта `/bin/control.sh` из директории проекта. Выполнять команду формирования отчёта можно как в хостовой ос, так и в контейнере app.

Для формирования отчёта, отражающего покрытие кода **всеми** тестами из каталога `src/tests` выполните команду:
```shell
mic t gr
```
Сформированный отчёт будет расположен в каталоге `var/PHPUnitCoverageReport` каталога проекта. Для его просмотра откройте в браузере файл index.html из него.
### Формирование отчётов по отдельным тестам
Для формирования отчёта, отражающего покрытие кода **единственным** тестом он должен быть передан в команду в качестве аргумента:
```shell
mic t gr путь/к/тесту/от/корня/проекта.php
```
Для формирования отчёта, отражающего покрытие кода тестами **из определённого каталога** он должен быть передан в команду в качестве аргумента:
```shell
mic t gr путь/к/каталогу/тестов/от/корня/проекта
```

## Отображение покрытия в PhpStorm
Для отображения информации о покрытии прямо в PhpStorm выполните:

`Run -> Run <выбранный набор тестов> with Coverage`

После этого можно будет видеть процент покрытия в дереве директорий, на специальной панели Coverage, а так же прямо в файлах в виде подсветки строк.

Для выбора набора тестов, которые будут использованы при формировании отчёта используйте выпадающий список с выбором конфигурации на панели запуска тестов.

Если закрыть панель Coverage, то данные о покрытии перестанут отображаться также и на панели Project и в области редактирования кода. Чтобы вернуть последние результаты, следует выполнить:
- `Run -> Show Coverage Data`,
- отметить самый свежий результат сбора данных о покрытии,
- нажать `Show Selected`.

## Особенности интерпретации результатов отчёта для данного проекта
Обращение к коду посредством обращения к ЭП через **Guzzle-клиент** **не приводит к его покрытию**. Это в первую очередь касается тестов-наследников **AuthTestCase** (эти тесты преимущественно находятся в каталоге `src/tests/ApiAction/PersonalArea/`). То есть эти тесты, даже при их успешном выполнении не вносят вклад в попадание кода в отчёт как покрытого.

Это происходит, потому что система оценки покрытия не может отследить обращения к коду, выполненные не в том же самом потоке, который запущен для теста. Guzzle-клиент вызывает отдельный поток выполнения при осуществлении запроса. Эту проблему можно обойти используя в тестах для запросов KernelBrowser вместо Guzzle, однако использование KernelBrowser сопряжено с рядом трудностей если этот запрос должен быть с авторизацией. Подробнее об этих проблемах и способах их обхода можно прочитать в [этом комментарии](https://g.8d9.ru/bookrat/myitcareer/-/issues/535#note_16377).

Данная проблема несущественна, так как в перспективе планируется не использовать функциональные тесты в качестве средства покрытия. То есть планируется считать код покрытым, только если его покрыл модульный тест.

## Настройки
### Выбор анализируемого кода
В файле **phpunit.xml.dist** в теге `<filter>` указан каталог с исходным кодом, который будет анализироваться для отчёта. Там же исключены некоторые его подкаталоги и отдельные файлы, которые было решено не анализировать.

### processUncoveredFilesFromWhitelist
Опция **processUncoveredFilesFromWhitelist** включена без веской причины.

Формулировка в документации может быть истолкована, что включение этой опции повышает корректность результатов.

На момент установки опции её включение незначительно отражалось на результате, немного понижая процент покрытия строк кода за счёт того что суммарное количество строк становилось больше по сравнению с отчётом, сформированным с отключенной данной опцией. Судя по нескольким просмотренным файлам с отличающимся суммарным числом анализируемых строк, в случае когда опция была включена, анализируемыми помечались строчки с открытой и закрытой фигурными скобками.

Включение данной опции может увеличивать длительность формирования отчёта.