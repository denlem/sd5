# Evaluation System - сервис опросник для пользователей сайта

## 1. Общая информация

Сервис позволяет использовать различные типы вопросов для пользователей:
* Вопрос с одним вариантом ответа
* Сообщение
* Открытый вопрос
* Просмотреть видео
* Оцените
* Подписка
* Email
* Изображение
* Вопрос с несколькими вариантами ответа

Вопросы, ответы, можно редактировать/смотреть через админку в разделах "Вопросы"
и "Ответы". Результаты ответов пользователей также находятся в разделе "Ответы",
правда там нет обобщенных результатов, а только информация по ответам на
конкретные вопросы в формате "`Название вопроса_номер ответа`"

Вопросы разделены на категории:
- Информационное сообщение
- Приглашение пройти курс по выбору IT-карьеры
- Подписка
- Email
- Видео 1. Вводное
- Видео 2. Плюсы и минусы работы в IT
- Видео 3. Тестировщик
- Видео 4. Верстальщик
- и т.д.

Категория - это набор вопросов принадлежащих к конкретному **тесту / квизу / голосованию**. 
Именно по категории идет извлечение набора вопросов для пользователя. 

Категории вопросов могут быть отнесены к одному или более **разделам** категорий вопросов. Например:
- Приглашение на курс по выбору IT-карьеры
- Выбор IT-карьеры (v1)
- Подписка
- Email
- Подходит ли мне IT-профессия

Разделы могут быть **приватными** либо **публичными**, соответственно тесты
могут быть, публичными, приватными либо публичными и приватными одновременно,
в зависимости от того к каким разделам категорий вопросов они относятся. Главное отличие
публичных от приватных - это возможность доступа без авторизации: к
публичной категории вопросов можно получить доступ без авторизации, к приватной нет.
Доступ к приватным категориям вопросов происходит через ЭП группы personal-area. Эти ЭП не
имеют доступа к публичным категориям вопросов. К одновременно публичным и приватным категориям вопросов
можно получить доступ из обеих групп ЭП.


## 2 Доступ к тестам

### Справедливое и для публичных и для приватных категорий вопросов
Раздел категорий вопросов можно отключить. За это отвечает свойство `isActive`. Категории вопросов из
неактивного раздела невозможно:
- получить,
- ответить на них,
- сформировать результат по ним.

Разделы категорий вопросов делятся на **типы**: тест, квиз, голосование и т. д.
Каждая ЭП должна обрабатывать свой тип категорий вопросов. То есть в ЭП выводящую список тестов пользователя, не будут попадать квизы и наоборот.

### Только для приватных категорий вопросов
#### Подписка и инвайт
Доступ к приватным категориям вопросов может быть ограничен по причине отсутствия у
пользователя актуального **инвайта** в раздел, запрашиваемой категории вопросов, а так же
по причине отсутствия **подписки**, если запрошенная категория вопросов требует её наличия.

Инвайт распространяется на раздел категорий вопросов, подписка в свою очередь
распространяется на все категории вопросов вне зависимости от раздела.

Подписка и инвайт не взаимозаменяемы. То есть для доступа к категории вопросов обязательно
должен быть актуальный инвайт и, если категория вопросов требует подписки, то актуальная
подписка.

Подписка хранится в сущности `User` в виде даты её истечения в свойстве 
`subscriptionUntil`. Инвайты пользователей хранятся в отдельной с сущности
`UserQuestionCategorySectionInvite`.

Отсутствие инвайта / подписки равнозначно тому что он / она не актуальны.



#### Повторное прохождение
Повторное прохождение приватного теста невозможно. Это означает, что если
процедура расчёта результата теста была произведена успешно и в БД был записан
обобщённый результат, то этот тест:
- будет по прежнему выводится в списке тестов;
- не может быть получен напрямую по id категории вопросов;
- ответы на него не будут приняты и записаны в БД;
- при повторном запросе формирования результата этого теста, он не будет
повторно формироваться, он будет получен из БД.


## 3. Формирование результата опроса (теста)

Результат представляет собой обобщённые данные о прохождении теста и отдаётся в
следующем виде:
```json
{
    "numberOfCorrect": 2,
    "numberOfWrong": 1,
    "numberOfQuestions": 4,
    "resultByQuestions": {
        "29": true,
        "30": false,
        "31": true
    },
    "percentOfCorrect": 67,
    "questionResultMessage": "Вы набрали 67%. Дальнейшие варианты:</br>\nа) начать ваш путь в IT</br>\nб) отпустить ситуацию (ссылка на гугл - как отпустить ситуацию)</br>"
}
```

На многие аспекты формирования результата влияет **стратегия его формирования**.
Например, единственная реализованная на данный момент стратегия **Full**,
подразумевает, что результат может быть сформирован, только если в тесте хотя бы
один вариант ответа на вопрос помечен как верный. Чтобы более подробно
ознакомиться аспектами формирования результата см. информацию о стратегии в
разделе **Стратегии формирования результата**.

Процент берётся не от количества вопросов, а от количества вопросов, для которых
существуют верные варианты ответа. За это поведение отвечает метод
CalculationResultDto::calcPercentOfCorrect(), вызываемый в стратегии
формирования результата, однако есть возможность установить процент через
публичный сеттер и после исполнения стратегии.

Сообщение, (`questionResultMessage`) задаётся индивидуально для каждого теста и
хранится в сущности `QuestionResultMessageLanguage` а связь с тестом в
`QuestionResultMessage`. 

Обращаю внимание, что несмотря на то, что `QuestionResultMessage` позволяет
хранить связь и с **разделом** тестов, это не означает, что сообщение, относящееся к разделу
тестов будет использовано для тестов с незаданными сообщениями результата.
Если для **теста** не задано никакого сообщения результата, оно не будет выведено,
даже если такое сообщение задано для **раздела тестов**. Сообщения результата,
относящиеся к разделам тестов используются только при формировании результата
целого раздела.

При создании сообщений результата, следует иметь в виду, что оно может содержать
1 плейсхолдер вида `%s%%` либо другого типа, например целочисленного, или с
плавающей точной. В него будет записано значение процента.


### Публичные тесты
Для формирования результатов прохождения публичных тестов нужно отправить на
сервер id теста и id всех выбранных пользователем ответов. Для
публичных тестов важно во время прохождения пользователем теста, сохранять все
результаты ответов на фронтенде, чтобы потом в конце теста отправить их одним
массивом на сервер, для расчета результата.


### Приватные тесты
Так как приватные тесты доступны только для авторизированных пользователей,
необязательно сохранять результаты ответов на фронтенде во время прохождения
тестов пользователем. Все ответы сохраняются на сервере и результат определяется
по ответам сохранившихся в базе данных, прикрепленных к определенному пользователю.

#### Формирование результата раздела тестов
Для приватных тестов можно сформировать результат для целого раздела.

Так же как и для отдельных тестов, для раздела может быть задано сообщение.
Оно хранится в той же сущности `QuestionResultMessage` а связь с разделом в
`QuestionResultMessage::$questionCategorySection`.


## 4. ЭП для работы с тестами
### Публичные
#### Получить тест (информация о тесте и вопросы)
`/component/evaluation-system/question-category/{slug категории вопросов}`

Метод: GET

Параметры:
- lang - обязательный.
- limit - не обязательный.
- offset - не обязательный.
- sort - не обязательный. Допустимы только целочисленные значения. Если задан,
то вопросы будут выведены в псевдослучайном порядке. Для одних и тех же значений
sort, порядок будет один и тот же. Это необходимо для корректной постраничной
выдачи при случайной сортировке.

Сортировка по умолчанию (при не заданном sort): по Question.priority ASC.

Limit, offset задают пагинацию вопросов.

Для получения вопросов эта ЭП использует тот же метод, что и аналогичная приватная ЭП.

Для подробной информации, о том, что может влиять на доступ к тесту см. раздел
**Доступ к категориям вопросов**

#### Ответить на тест и получить результат
`/component/evaluation-system/result/question-category/{id категории вопросов}`

Метод: POST

Id-ы ответов должны быть переданы в теле запроса в виде массива. Вопросы
передавать не нужно, так как варианты ответа хранят связь с вопросом.

#### Страница публичного теста
`/page/test/{slug}`

Метод: GET

Для получения данных теста использует тот же функционал, что и **публичная ЭП Получения теста**, параметры те же.

#### Страница списка публичных тестов
`/page/tests`

Метод: GET

Параметры:
- lang - обязательный.
- limit - не обязательный (10 по умолчанию).
- offset - не обязательный.

Сортировка по `QuestionCategory.priority` `ASC`.

Показывает только активные публичные **тесты**, то есть категории вопросов из раздела с типом раздела "тест".

### Приватные
#### Получить тест (информация о тесте и вопросы)
`/personal-area/component/evaluation-system/question-category/{id теста}`

Метод: GET

Параметры: см. аналогичную публичную ЭП.

Для получения информации о тесте и вопросов эта ЭП использует те же методы, что
и аналогичная публичная ЭП.

Для подробной информации, о том, что может влиять на доступ к тесту см. раздел
**Доступ к категориям вопросов**

#### Страница теста
`/personal-area/page/test/{id теста}`

Метод: GET

Для получения данных теста использует тот же функционал, что и приватная ЭП
**Получения теста**, параметры те же.

#### Список тестов пользователя
`/personal-area/component/evaluation-system/question-categories`

Метод: GET

Выводит список **доступных** для прохождения пользователем тестов, а так же уже **пройденные**.  
- Если тест **не пройден** в ответе будет заполнен элемент `link`. 
- Если тест **пройден** - то будет заполнен элемент `result`, а `link` будет равен `null`.

Оба элемента и `result` и `link` присутствуют в ответе в любом случае. От того пройден ли тест, зависит только, какой из них будет равен `null`.

Параметры:
- lang - обязательный.
- limit - не обязательный.
- offset - не обязательный.

Сортировка по `QuestionCategory.priority` `ASC`.

Для подробной информации, о том, что может влиять на доступ к тесту см. раздел
**Доступ к категориям вопросов**

#### Страница тестов пользователя
`/personal-area/page/tests`

Метод: GET

Для получения списка тестов использует тот же функционал, что и приватная ЭП
**Список тестов пользователя**, параметры те же.

#### Отправка ответов на вопросы
`/personal-area/handler/evaluation-system/answer`

Метод: POST

Ответы отправляются в теле запроса в следующем формате:
```json
[
    {
        "id": 1,
        "datetime_question": 1652517766,
        "datetime_answer": 1652518866
    },
    {
        "question_id": 5,
        "text": "В видео не хватает субтитров",
        "datetime_question": 1652517766,
        "datetime_answer": 1652518866
    },
    {
      "id": 35,
      "text": "Включить аппаратное ускорение",
      "datetime_question": 1652517766,
      "datetime_answer": 1652518866
    }
]
```
ЭП позволяет отправлять как ответы на вопросы, где требуется выбор из вариантов
ответов, так и на вопросы не имеющие вариантов ответов вовсе, и требующие
текстового ответа (например вопросы типа `Открытый вопрос` или `Email`)

- Первый ответ в примере - ответ на вопрос с вариантами ответа. Здесь id - это 
id ответа (`QuestionAnswer` а не `Answer`);
- Второй - ответ на вопрос без вариантов ответа;
- Третий - ответ на вопрос с вариантами ответа, но передан текст, который так же
будет сохранён с ответом. Никакой логики обработки таких дополнений к ответу
при формировании результата нет.

Если хотя бы один из ответов не будет удовлетворять требованиям, все вопросы не
будут приняты.

Требования:
- Должен удовлетворять ограничениям из `QuestionAnswerParamDto`, в частности 
должны быть заданы `datetime_question` и `datetime_answer`;
- У пользователя должен иметься доступ к категории вопросов, к которой относится ответ
(см. раздел **Доступ к категориям вопросов**);
- Ответ не должен принадлежать категории вопросов, по которой уже сформирован результат;
- Ответ не должен даваться повторно. Однако повторным считается только ответ,
содержащий тот же самый вариант ответа. Если ответ даётся на тот же вопрос, на
который уже сохранён ответ в БД, но вариант ответа отличается от сохранённого,
то такой ответ так же будет сохранён в БД и не будет считаться повторным
ответом. Дело в том, что есть вопросы, для которых верным является выбор
нескольких вариантов ответа, так что такой ответ на тот же вопрос, но с новым
вариантом ответа будет рассмотрен как дополнение старого ответа.

Отправлять сразу все ответы на тест не обязательно, кроме того не все ответы
обязательно должны принадлежать одной и той же категории вопросов.

#### Получить результат категории вопросов
`/personal-area/component/evaluation-system/result/question-category/{id категории вопросов}`

Обработает имеющиеся на данный момент в БД ответы пользователя на запрошенную 
категорию вопросов и запишет в БД результат, а так же отдаст их в ответе. Если результат уже
был сформирован, (имеется в БД), то повторное формирование не будет производиться,
результат будет взят из БД и отдан в ответе.

Подробнее - что такое результат и структуру ответа см. в разделе
**Формирование результата опроса (теста)**.

Параметры:
- lang - обязательный.

Если результат формируется впервые, требования, описанные в разделе
**Доступ к категориям вопросов** должны выполнятся, если это уже сформированный результат,
он может быть получен авторизованным пользователем без учёта подписки, инвайта
и прочих аспектов доступа.

#### Получить результат раздела тестов
`/personal-area/component/evaluation-system/result/question-category-section/{id категории вопросов}`

Метод: GET

Аналогична ЭП **Получить результат категории вопросов**. Подробнее в подразделе
**Формирование результата раздела тестов**, раздела **Формирование результата
опроса (теста)**

Параметры:
- lang - обязательный.

При формировании результата обращается к функционалу получения результата отдельной
категории вопросов, соответственно, если ранее результаты тестов не были сформированы, то вызов
этой ЭП приведёт к их формированию и сохранению в БД.

Если среди категорий вопросов раздела есть категории вопросов, для которых результат не удаётся сформировать, то результат раздела сформирован не будет.

## 5. ЭП Для работы с квизами
### Публичные
#### Страница публичного квиза
`/page/quiz/{slug}`

Метод: GET

Параметры:
- lang - обязательный.
- limit - не обязательный.
- offset - не обязательный.
- sort - не обязательный. Допустимы только целочисленные значения. Если задан,
  то вопросы будут выведены в псевдослучайном порядке. Для одних и тех же значений
  sort, порядок будет один и тот же. Это необходимо для корректной постраничной
  выдачи при случайной сортировке.

Сортировка по умолчанию (при не заданном sort): по Question.priority ASC.

Limit, offset задают пагинацию вопросов.

#### Страница списка публичных квизов
`/page/quizzes`

Метод: GET

Параметры:
- lang - обязательный.
- limit - не обязательный (10 по умолчанию).
- offset - не обязательный.

Сортировка по `QuestionCategory.priority` `ASC`.

Показывает только активные публичные **квизы**, то есть категории вопросов из раздела с типом раздела "квиз".

## 6. Описание сущностей и кода

- `Question` - вопросы
  - Поле `params` в сущности `Question` служит для замены значений по маске в
  тексте вопроса - раньше это поле было отдельной сущностью и лежало почему-то в
  сущности `QuestionAnswer`. Поле `params` редактируется из админки, как
  текстовое, но оно должно быть в виде массива, то есть это должны быть строки
  вида `[3,54,87]`.
- `QuestionLanguage` - переводы вопросов
- `QuestionAnswer` - варианты ответов на вопросы
  - Ответ хранит ссылку на вопрос и порядковый номер ответа. Сделать дубль
  номеров не получится, так как есть ограничение уникальности по вопросу и
  номеру.
- `QuestionAnswerLanguage` - переводы ответов на вопросы
- `Answer` - порядковые номера ответов
- `UserAnswerQuestion` - ответы пользователей.
  - Ответ может быть либо в формате варианта ответа, тогда он хранится в
    свойстве `questionAnswer`, либо просто строкой (если это, например, ответ на
    открытый вопрос), тогда он хранится в свойстве `text`.
- `QuestionCategory` - категория вопросов (тест / квиз / голосование и т. д.)
  - Задаёт стратегию определения правильности вопросов;
  - Можно устанавливать требование подписки.
  - `QuestionCategory` <- ManyToMany -> `QuestionCategorySection`
- `QuestionCategorySection` - Раздел категорий (тестов)
    - Может быть приватной либо публичной (свойство `isPublic`).
    - Может быть отключена при помощи свойства `isActive`.
- `QuestionCategoryResultCalculationStrategy` - стратегии формирования
результата категории вопросов. Например: "правильный ответ, только если все варианты в
вопросе выбраны правильно" либо "правильный ответ, если хотя бы один вариант в
вопросе выбран правильно".
- `UserQuestionCategoryResult` - сформированные результаты категорий вопросов, на которые пользователями были даны ответы.
- `UserQuestionCategorySectionResult` - суммарные результаты категорий вопросов из целого
раздела.
- `UserQuestionCategorySectionInvite` - инвайты пользователей в разделы категорий вопросов.
Без актуального инвайта невозможно пройти приватный тест и сформировать
результат по нему.
- `User.subscriptionUntil` - свойство, в котором хранится дата и время истечения
подписки пользователя. Если приватная категория вопросов требует подписки, то без актуальной
подписки невозможно его пройти и сформировать по нему результат.
- `QuestionType` - тип вопроса (см.выше)
- `QuestionTypeLanguage` - перевод типа вопроса
- `QuestionCategorySectionType` - типы разделов категорий. Например: Course,
Test,  Quiz,  Poll
- `EvaluationSystem` - сервис для получения отдельных категорий вопросов, списков категорий вопросов, доступных пользователям, вопросов отдельной категории вопросов и т.д.
- `AnswerManager` - сервис для сохранения ответов **авторизованных** пользователей.
- `QuestionResultMessageManager` - сервис для получения сообщений результата
категории вопросов и разделов категорий вопросов.
- `Calculation\CalculationCategory` - сервис для формирования результата
отдельной категории вопросов. Используется как для приватных, так и для публичных.
- `Calculation\CalculationSection` - сервис для формирования результата
  **раздела** категорий вопросов. В работе использует `CalculationCategory` для получения
  результатов отдельных категорий вопросов. На данный момент работает только с приватными.
- `Calculation\CalculationStrategy\` - каталог с реализациями стратегий
формирования результата.

## 6. Стратегии формирования результата
Стратегия задаётся для категории вопросов. То есть для отдельных вопросов нельзя выбрать
отдельную стратегию.

Для создания новой стратегии нужно написать класс, который будет реализовывать
`App\Service\EvaluationSystem\Calculation\CalculationStrategy\AbstractStrategy`
добавить её имя в `QuestionCategoryResultCalculationStrategy` и соответствующий
ей case в switch метода `CalculationCategory::calcResult`.

Стратегия работает не с ответом в отдельности, а с набором ответов, для которых
нужно сформировать результат. Кроме определения правильности конкретного ответа,
стратегия ответственна за подсчёт количества правильных и неправильных ответов,
так что именно она должна внести эти данные в CalculationResultDto, который
является результатом работы стратегии. Однако она ответственно не за все
свойства этого DTO. Ниже приведён список свойств, которые должна заполнить
стратегия:
- `numberOfCorrect`;
- `numberOfWrong`;
- `numberOfQuestion`;
- `numberOfQuestionsThatHasCorrectAnswers`;
- `resultByQuestions`;
- `percentOfCorrect` посредством вызова `calcPercentOfCorrect`;

Единственное свойство, которое заполняется вне стратегии - `questionResultMessage`.

Стратегия не обязана проверять покрытия всех вопросов категории вопросов ответами. Она
оперирует двумя массивами: варианты ответов (`QuestionAnswers`) и id-ы вариантов
ответов, выбранные пользователем, соответственно если ей будет передан массив 
`QuestionAnswers`, не полностью покрывающий вопросы категории вопросов, стратегия может не
обращать на это внимания.

### Реализованные стратегии
#### Full
Основной особенностью этой стратегии является оценка вопросов, для которых более
одного вариантов ответа являются правильными. Согласно стратегии Full ответ на
вопрос с несколькими вариантами ответа считается правильным, только если выбраны
все варианты ответа, помеченные как правильные.

Результат может быть сформирован, только если в категории вопросов хотя бы один вариант
ответа на вопрос помечен как верный, то есть в массиве `QuestionAnswers`, хотя
бы один из вариантов ответа имеет свойство`isCorrect` равное `true`.

Сумма количеств правильных и неправильных ответов может не совпадать с
количеством вопросов. Это происходит в том случае, если в категории вопросов есть вопросы,
для которых не существует правильных вариантов ответа (не существует в принципе,
а не среди ответов пользователя).