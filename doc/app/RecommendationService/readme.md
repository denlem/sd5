# Рекомендательный сервис


## 1. Административный раздел настройки дерева рекомендаций
  Интегрировано в SonataAdmin, раздел Рекомендации->Рекомендации (дерево) 
 ~~https://api.myitcareer.local.test:444/recommendation_tree/admin?lang=ru~~

## 2. Общая информация

- Рекомендации (`Recommendation`) выполняют роль вопросов или заглавий предполагаемых(-ого) действия(-я)
- Действия(`Action`) выполняют роль вариантов ответов или вариантов развития событий или вариантов реакций на рекомендацию
- Действия ссылаются только на вызываемую рекомендации (`next recommendation`), а не на действия
- Каждое действие имеет одну родительскую рекомендацию. Рекомендация может иметь несколько действий
- Строится не дерево действий (`actionTree` - устарвешее), а дерево рекомендаций(`recommendationTree`). Причем для
  пользователя могут быть прикреплены несколько деревьев рекомендаций, а потому достается группа деревьев рекомендаций
  в виде массива. Для этого испрользуется метод `getGroupOfRecommendationTrees`
- Узлами дерева рекомендаций выступают рекомендации. Дерево включает в себя и действия(`action`) как условия 
  для ветвления - соединяющие ветки между рекомендациями.
- К сущностям или событиям прикрепляется дерево(набор) рекомендаций(`RecommendationTree`) (таблица `recommendation_tree`), 
  а не действия. Соответственно, для каждой сущности (но не события) будут свои таблицы которые будут их связывать 
  с деревьями(наборами) рекомендациями. Они будут называться типично по доктриновски - имя основной сущности 
  `recommendation_tree` плюс имя связываемой сущности, вот так `recommendation_tree_[entity]`.
- Отдельная сущность `recommendation_activity` создана для того, чтобы привязывать деревья рекомендаций 
  к событиям или наборам действий, возможно наборам сущностей или каким то кастомным условиям. 
  Связка с деревом рекомендаций работает по принципу связок последних с сущностями. 
  Соответственно таблица связи будет называться `recommendation_tree_recommendation_activity`
- Конечная рекомендация в дереве рекомендаций будет иметь одно или несколько действий, которые не указывают ни на какие
  рекомендации(null), и является по факту результирующими сообщениями о прохождении дерева(группы) рекомендаций.
  Смысл этой рекомендации в том, чтобы показать пользователю результирующее требуемое сообщение с ссылками, стилями 
  и html кодом если потребуется
- Дерево рекомендаций имеет минимум 1 рекомендацию и минимум одно действие, которое не вызывает ни одну рекомендацию. 
- Для пользователя в случае если в дереве не остается рекомендаций, либо все рекомендации дерева имеют статус 
  isCompleted=true,то такое дерево удаляется из результирующего набора деревьев $this->recommendationTree которые 
  найдены для конкретного пользователя. То есть это означает что пользователь прошел все рекомендации данного дерева
- Есть внутренний сервис поиска рекомендаций `RecommendationSearcher`, где описавается вся бизнес-логика поиска
  всех рекомендаций для выбранного пользователя. Суть алгоритма поиска в том, что идет поочередный поиск рекомендаций 
  для конкретного пользователя по сущностям, событиями и другим алгоритмам: по карьере, мероприятию, профессии, группе 
  профессий, времени года, поведению пользователя. После этого суммируются все найденные рекомендации, 
  сгруппированные в деревья, и удаляются повторяющиеся деревья, которые с большой вероятностью могут встречаться в 
  разных условиях поиска рекомендаций. В будущем можно будет доработать функционал как угодно - к примеру при 
  определенных условиях не предлагають пользователю какие-то найденные рекомендации(деревья), например если он раньше 
  уже прошел курсы которые предлагаются в рекомендациях этого дерева, и т д..
- На данный момент одна рекомендация не может повторяться в разных деревьях. Пока сделано так. Соответственно и экшены,
  которые к ней прикреплены, могут быть только в одном дереве.
- На данный момент действия (`action`) не могут повторятся в разных деревьях, они всегда уникальны. Это сделано 
  потому, что у нас изначально логика завязана на уникальный экшен, например добавление экшена только по id экшена.
  Так сделано потому, что при каждом присоединении nextRecommendation к Action нужно будет либо 
  иметь флаг дерева, либо проставлять по всем деревьям связку эту, что не есть правильно. Сейчас пока флаг дерева
  не передается ни в каких манипуляциях с экшенами, потому связка экшена (триггер) может быть только в одном дереве
  В будущем можно сделать возможность добавлять экшены и к деревьям, но тут надо доработка структуры данных и логики
  исходя из передачи флага дерева.
- Сейчас при добавлении связки экшена на другую рекомендацию нужно проверять - нет ли связки этого экшена 
  в других деревьях. Если есть то связку экшена запрещено добавлять. Но наверное будем делать это по рекомендации.


## 3. Описание сущностей
- **Recommendation** - рекомендация
- **Action** - действия, экшен, имеет связь manyToOne с `Recommendation`
- **RecommendationTree** - это группа(набор, дерево) рекомендаций, которая собирается в дерево,
    При этом коллекции которые имеются у сущности(записи) `RecommendationTree` - это те сущности или события
    к которым прикрепляются деревья(наборы/группы) рекоменадций\
    Таким образом у нас есть к примеру таблица(сущность) `recommendation_tree_career`, которая имеет связи
    с наборами рекомендаций и карьерами, по которой легко найти карьеру(-ы) которая и все возможные наборы рекомендаций
    к этой карьере(-ам)
- **RecommendationActivity** - Дополнительная сущность создана для прикрепление рекомендаций ко всему кроме сущностей:
   - к событиям, дате, времени
   - сразу ко всем записям определенной сущности (набора сущностей)
   - к особенностям набора пользовательских действий
   - к набору сущностей по какому-то признаку (возрасту, полу, дате регистрации и т.д.)
   - и т.д.
- **RecommendationTreeInProgress** - тут содержатся записи текущих активных деревьев которые проходят пользователи,
   это делается для того, чтобы не запускать логику поиска нового набора рекомендаций для пользователя, если он 
   проходит уже какой-то набор, при этом у него изменились характеристики (например профессия) и из-за новых условий 
   поисковый сервис может найти другой набор рекомендаций, а текущий набор исключить из списка, потому что тот не 
   подходит по условиям новым
    - Добавление записи в таблицу происходит в момент размещение actionCompleted action-триггер которого равен null
    - Удаление записи из таблицы происходит в момент размещение actionCompleted который указывает на null-рекомендацию
- **ActionCompleted** - завершенные действия конкретных пользователей
- **ActionPreCompleted** - действия которые могут быть завершены только по факту выпонения внешних условий
   состояния пользователя, его различных активностей и т.д. но ни как не по факту нажатия на кнопок 
   экшена о том, что рекомендация выполнена (например кнопка согласия с тем что какой-то курс пройден)
- **ActionCompleteCondition** - Сущность дополнительных условий по исполнению которых данное действие помечается 
    выполненным, а точнее isChosen. Такое действие помечается выполненным автоматически, и не может быть выолнено
    вызовом экшена выполнения действия
- **ActionStyle** - стили для действий (возможно также понадобятся стили для рекомендаций)
- Ссылка на данные фикстур рекомендательного сервиса, представленные в табличном виде, сделано 
  так для удобного понимания данных
  https://docs.google.com/spreadsheets/d/1Qiz-Nt-yTytuG4-MVYp-3FgpiFwedE50Echs5lv7Lik/edit?usp=sharing

- Ссылка на pdf с основными рекомендациями, которые реализованы на уровне юнит тестов
  https://g.8d9.ru/bookrat/myitcareer/-/wikis/uploads/a29f934a6e177077750ea355226917df/Development_schemes__4_.pdf

## 4. Пример данных группы деревев рекомендаций, в которой имеется 3 дерева с ID равными 1, 4 и 5

```
Array
(
    [1] => Array
        (
            [id] => 1
            [recommendations] => Array
                (
                    [1] => Array
                        (
                            [isInitial] => 1
                            [id] => 1
                            [name] => Установите аватар
                            [isCompleted] => 
                            [actions] => Array
                                (
                                    [0] => Array
                                        (
                                            [id] => 1
                                            [nextRecommendationId] => 2
                                            [isChosen] => 
                                            [timestamp] => 
                                            [header] => Установка аватара
                                            [text] => Выберите изображение для аватара и загрузите его на сайт
                                            [additionalInfo] => Тут пользователь добавляет аватарку
                                            [styleId] => 1
                                            [styleName] => Текст
                                            [styleDescription] => Текст, который может содержать HTML-разметку, включая внутренние и внешние ссылки. Без динамических параметров
                                        )

                                    [1] => Array
                                        (
                                            [id] => 2
                                            [nextRecommendationId] => 2
                                            [isChosen] => 
                                            [timestamp] => 
                                            [header] => Пропустить
                                            [text] => Отложить установку аватара
                                            [additionalInfo] => Отказ от аватара. Можно предожить пользователю добавить аватар позже
                                            [styleId] => 2
                                            [styleName] => Default action button
                                            [styleDescription] => Цвет: дефолтный. Состоит из элементов: 1) "description" - описание экшена, которое может содержать ссылки; 
            2) "buttonText" - текст на кнопке. Также может содержать опциональный 3ий элемент "info" - текст подсказки, который всплывает при наведении на значок дополнительной информации
                                        )

                                )

                        )

                )

        )

    [4] => Array
        (
            [id] => 4
            [recommendations] => Array
                (
                    [13] => Array
                        (
                            [isInitial] => 1
                            [id] => 13
                            [name] => Посмотрите курс (курс PHP #1)
                            [isCompleted] => 
                            [actions] => Array
                                (
                                    [0] => Array
                                        (
                                            [id] => 14
                                            [nextRecommendationId] => 14
                                            [isChosen] => 
                                            [timestamp] => 
                                            [header] => Да
                                            [text] => Да, понравился (курс PHP #1)
                                            [additionalInfo] => 
                                            [styleId] => 3
                                            [styleName] => Red action button
                                            [styleDescription] => Тоже, что #2 "Default action button", но цвет красный
                                        )

                                    [1] => Array
                                        (
                                            [id] => 15
                                            [nextRecommendationId] => 15
                                            [isChosen] => 
                                            [timestamp] => 
                                            [header] => Нет
                                            [text] => Нет, не понравился (курс PHP #1)
                                            [additionalInfo] => 
                                            [styleId] => 3
                                            [styleName] => Red action button
                                            [styleDescription] => Тоже, что #2 "Default action button", но цвет красный
                                        )

                                )

                        )

                    [14] => Array
                        (
                            [id] => 14
                            [name] => Пройдите курс (курс PHP #1) и оставьте отзыв
                            [isCompleted] => 
                            [actions] => Array
                                (
                                    [0] => Array
                                        (
                                            [id] => 16
                                            [nextRecommendationId] => 16
                                            [isChosen] => 
                                            [timestamp] => 
                                            [header] => Отзыв о курсе
                                            [text] => Отзыв (курс PHP #1)
                                            [additionalInfo] => 
                                            [styleId] => 3
                                            [styleName] => Red action button
                                            [styleDescription] => Тоже, что #2 "Default action button", но цвет красный
                                        )

                                )

                        )

                    [17] => Array
                        (
                            [id] => 17
                            [name] => Выберите сферу будущей не IT-профессии
                            [isCompleted] => 
                            [actions] => Array
                                (
                                    [0] => Array
                                        (
                                            [id] => 17
                                            [nextRecommendationId] => 16
                                            [isChosen] => 
                                            [timestamp] => 
                                            [header] => Отзыв об обучающих материалах
                                            [text] => Обучающие материалы прочитаны, отзыв оставлен
                                            [additionalInfo] => 
                                            [styleId] => 3
                                            [styleName] => Red action button
                                            [styleDescription] => Тоже, что #2 "Default action button", но цвет красный
                                        )

                                )

                        )

                    [18] => Array
                        (
                            [id] => 18
                            [name] => Поздравляем! Вы выбрали профессию. Вам подходит профессия %
                            [isCompleted] => 
                            [actions] => Array
                                (
                                    [0] => Array
                                        (
                                            [id] => 18
                                            [nextRecommendationId] => 16
                                            [isChosen] => 
                                            [timestamp] => 
                                            [header] => Прочитаю потом
                                            [text] => Прочитаю в другой раз
                                            [additionalInfo] => 
                                            [styleId] => 3
                                            [styleName] => Red action button
                                            [styleDescription] => Тоже, что #2 "Default action button", но цвет красный
                                        )

                                )

                        )

                )

        )

    [5] => Array
        (
            [id] => 5
            [recommendations] => Array
                (
                    [17] => Array
                        (
                            [isInitial] => 1
                            [id] => 17
                            [name] => Выберите сферу будущей не IT-профессии
                            [isCompleted] => 
                            [actions] => Array
                                (
                                    [0] => Array
                                        (
                                            [id] => 19
                                            [nextRecommendationId] => 18
                                            [isChosen] => 
                                            [timestamp] => 
                                            [header] => Медицина
                                            [text] => Выберите медицину если имеете потребность помогать страждущим
                                            [additionalInfo] => 
                                            [styleId] => 3
                                            [styleName] => Red action button
                                            [styleDescription] => Тоже, что #2 "Default action button", но цвет красный
                                        )

                                    [1] => Array
                                        (
                                            [id] => 20
                                            [nextRecommendationId] => 18
                                            [isChosen] => 
                                            [timestamp] => 
                                            [header] => Образование
                                            [text] => Выберите образование если имеете склонность обучсать знаниям и делиться опытом
                                            [additionalInfo] => 
                                            [styleId] => 3
                                            [styleName] => Red action button
                                            [styleDescription] => Тоже, что #2 "Default action button", но цвет красный
                                        )

                                )

                        )

                )

        )

)
```