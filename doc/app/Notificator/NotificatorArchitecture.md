# Общее описание архитектуры нотификатора. План разработки


## План
1. Приоритеты разработки
2. Виды уведомлений
3. Этапы отправки уведомления
4. Фильтры отправки уведомлений
5. Ускорение работы сервиса уведомлений
6. Ресурсы которые возможно будут задействованы для нотификатора
7. Ссылки на статьи

## Приоритеты разработки сервиса уведомлений
(1) - Основная архитектура сервиса уведомлений (разработка в первую очередь)
(2) - Расширение функциональности сервиса уведомлений
(3) - Оптимизация сервиса уведомлений

## Виды уведомлений

### 1. По каналу передачи
- (1) Telegram
- (1) Email
- (2) Push уведомления в приложении смартфона
- (2) Push уведомления в браузере
- (2) Колокольчик на сайте в верхнем углу

### 2. По массовости
- (1) конкретному пользователю
- (2) группе пользователей по определенному признаку

### 3. По времени отправки
- (1) сразу (после тригерного события)
- (2) планово (кроном) для всех неотправленных уведомлений
- (2) в определенное конкретное время для конкретного уведомления

### 4. По месту отправки
- (1) в сервисах после срабатывания какого-то события (прямой вызов отправки уведомления)
- (2) в крон скриптах (плановый вызов)
- (2) вызов администратором отправки уведомления из веб интерфейса (тут надо будет добавить механизм фиксации отправки для конкретного случая)

### 5. По механизму
- (1) вызов создание и тут же отправки в очередь
- (2) вызов только массового создания с отправкой
    - либо сразу
    - либо позже

### 6. По механизму создания сообщения
- (1) сразу без шаблона
- (1) используя шаблон

### 7. По настройке подписки
- (1) без подписки (отправляются всегда и всем)
- (2) с подпиской на определенные сообщения (отправляются только при подписке)

### 8. По количеству отправки разных типов уведомлений при одном событии
- (1) отправка одного типа уведомления (например только уведомление одного пользователя)
- (2) отправка нескольких типов уведомлений (1 - для одного пользователя, 2 - для админа, 3 - для группы пользователей)

### 9. По языку
- (2) русский
- (2) английский

### 10. По агрегации
- (1) отправка разрозненных уведомлений, последовательно
- (2) отправка одновременно сразу группы уведомлений с одинаковыми характеристиками

### 11. По провайдеру отправок
- (1) отправка собственными ресурами не сервере
- (2) отправка с помощью внешних сервисов массовых рассылок и уведомлений


## Этапы отправки уведомления

1. (2) Генерация задания на генерацию группы уведомлений (в случае массовой отправки)
   CreateTaskNotification()


2. (1) Генерация общего уведомления без деталей
   CreateNotification()

   Делается:
    - сразу
    - кроном на основе задания TaskNotification


3. (1) Детализация уведомления
   CreateNotificationChannels()
    - разбиение по каналам
    - генерация содержимого на основе темплейтов темплейтов
    - возможно назначение времени отправки

   Делается:
    - сразу
    - кроном, на основе созданных уведомлений Notification


4. (1) Отправка в очередь
   SendToQueue()


5. (2) Либо отправка внешнему провайдеру уведомлений
   SendToExternalNotificationService()


6. (1) Отправка из очереди пользователю
   Send()


7. (2) Получение отчетов об отправке от внешнего провайдера 
   уведомлений в случае отправки через него


8. (1) Отметка информации, что уведомление отправлено 
    Возможно этот этап не нужен, а сразу удалять


9. (1) Удаление отправленных уведомлений



## Фильтры отправки уведомлений

1. (2) Отправка по расписанию


2. (2) Отправка с учетом лимита отправок в один канал
- в телеграм бот не более 1 сообщения в секунду
- в телеграме при массовой отправке не более 30 уведомлений в секунду
- телеграм бот отправляет не более 20 сообщений в минуту в одну и ту же группу
  https://translated.turbopages.org/proxy_u/en-ru.ru.95648528-64cba71c-717364ca-74722d776562/https/core.telegram.org/bots/faq#my-bot-is-hitting-limits-how-do-i-avoid-this

3. (2) Блокировки различные (блокировка пользователей, блокировка группы, отмена мероприятия, блокировка типа сообщения)


## Ускорение работы сервиса уведомлений

1. (3) Развернуть редис, куда положить статическую информацию про все возможные собщения, чтобы постоянно не напрягать основную базу
* типы сообщений
* каналы сообщений
* шаблоны сообщений по каналам

2. (3) Возможно хранить сущность  NotificationChannel в
* memory таблице
* redis

3. (3) Сразу кидать в очередь сообщения, пропуская NotificationChannel
* для определенных групп сообщений, где не требуются фильтры перед погружением в очередь (емейлы и т д)


## Ресурсы которые возможно будут задействованы для нотификатора
* RabbitMQ
* Cron
* Redis

## Ссылки на статьи
1. Обсуждение данной архитектуры на форуме специалистов
   https://qna.habr.com/q/1297402


2. Центр уведомлений. Приручаем 200+ рассылок
   https://habr.com/ru/companies/true_engineering/articles/358198/

3. Другие полезные ссылки
*   https://procodings.ru/dev-ru/proektirovanie-sluzhby-uvedomleniy-s-diagrammami/
*   https://habr.com/ru/companies/ispsystem/articles/504934/
*   https://procodings.ru/dev-ru/arhitektura-uvedomleniy-dlya-sotsialnyh-setey-otpravka-millionov-uvedomleniy-v-den/
*   https://www.youtube.com/watch?v=l8EWDilTMr4
*   https://fritool.ru/new-in-symfony-5-2-notifier-improvements/
*   https://habr.com/ru/articles/147585/ GCM – новый сервис Push-уведомлений от Google
*   https://habr.com/ru/articles/302002/ Push уведомления в Android с помощью Firebase Cloud Messaging для начинающих
*   https://habr.com/ru/companies/wrike/articles/479324/
*   https://qna.habr.com/answer?answer_id=844006#comments_list_844006
*   https://qna.habr.com/q/906607
 