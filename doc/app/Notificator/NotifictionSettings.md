# Настройки нотификатора

## Настройка включающая/выключающая отправку нотификаций через каналы использующие rabbitMQ

В базовом продюсере `Messaging/Producer/BaseProducer.php` следующее условие запрещает отправку нотификаций
через очередь, в зависимости от окружения и т д..

        if ($this->isForbiddenPublishingToQueue()) {
            return;
        }

Чтобы полоностью разрешить отправку всех нотификаций, например при локальном тестировании, нужно закомментировать это условие

## Настройки запуска крон команд

В зависимости от окружения, у нас имеются файлы настроек, которые определяют - какие крон процессы будут запущены в конкретном окружении

        config/docker/cron/config.test.ini
        config/docker/cron/config.dev.ini
        config/docker/cron/config.stage.ini
        config/docker/cron/config.prod.ini

Для локального проекта, который работает с тестовой базой, крон джобы настраиваются в файле `config/docker/cron/config.test.ini`


## Системные настройки для массовых уведомлений

Эти настройки нужны для того чтобы регулировать пропускную способность отправки нотификаций для крон процессов нотификатора, 
которые обеспечивают работу подготовки и отправки массовых уведомлений, а именно:

        notificator:create-user-ids-data  ( класс: src/Command/Notification/CreateUserIdsData.php )
        notificator:push-multi-notification-to-queue  ( класс: src/Command/Notification/PushMultiNotificationToQueue.php )

### Для команды notificator:create-user-ids-data такие настройки:

   `LIMIT_MULTINOTIFICATIONS_FOR_PROCESSING      = 10;`
   Определяет - сколько мультинотификаций будет обрабатываться за один вызов команды.
   Тут надо учитывать, что одна мультинотификация может быть рассчитана на всех пользователей в таблице user,
   а это может быть и миллион пользователей. Потому на начальном этапе тут будет несколько нотификаций, а в будущем
   количество нотификацию может свестись к единице.
   И если будет миллион пользователей, то все id пользователей не смогут вместиться в одну строчку в одно поле мультинотификации,
   а значит надо будет разделять мултинотификацию на несколько штук. (Задача #610)
   
   `LIMIT_TIME_FOR_PROCESSING_MULTINOTIFICATIONS = 45; // в секундах`
   Определяется общее время работы всего процесса. Если процесс работат дольше - то он прерывается. Но следуюет учитывать,
   что прерывание процесса идет только после завершения итерации работы с нотификацией, а это означает, что
   если будет много пользователей, то это может выйти далеко за рамки этого лимита по времени
   А значит в дальнейшем задача #610 должна решить эту проблему


### Для команды notificator:push-multi-notification-to-queue такие настройки:
   
   `LIMIT_MULTINOTIFICATIONS_FOR_PROCESSING    = 10;`
   Определяет - сколько мультинотификаций будет обрабатываться за один вызов команды. 
   Тут надо учитывать, что одна мультинотификация может быть рассчитана на всех пользователей в таблице user, 
   а это может быть и миллион пользователей. Потому на начальном этапе тут будет несколько нотификаций, а в будущем
   количество нотификацию может свестись к единице
         
   `LIMIT_USERIDS_PER_ITERATION                = 1000;`
   Определяет - сколько пользователей берется из нотификации за один проход для отправки им уведомлений
   Один пользователь может иметь несколько каналов для отправки уведомлений (например 5). Потому за один проход 1000 пользователей
   может быть разослано к примеру даже 5000 уведомлений в очередь. Это может занять заметное количество времени. Также надо учитывать, 
   что слишком большое значение этой величины может давать сбои при каких то операциях со строками, из-за текучки памяти к примеру
   или других внутренних лимитов php установленных для работы со строками

   `LIMIT_TIME_FOR_PROCESSING                  = 45; // in seconds`
   Определяется общее время работы всего процесса. Если процесс работат дольше - то он прерывается. Но следует учитывать, 
   что прерывание процесса идет только после завершения итерации работы с нотификацией, а это означает, что 
   если будет много пользователей, то это может выйти далеко за рамки этого лимита по времени LIMIT_TIME_FOR_PROCESSING
   А значит в дальнейшем имеет смысл создать дополнительную логику, которая уже будет останавливать процесс после завершения
   итерации обработки порции пользователей установленной параметром LIMIT_USERIDS_PER_ITERATION (задача #609)

   `AVERAGE_LIMIT_PUBLISHED_MULTINOTIFICATIONS = 10000;`
   Лимит отправки сообщений. Проверка лимита вызывается после полного завершения обработки одной мультинотификации, 
   а значит лимит может быть значительно превышен. Но это не так страшно, потому что если доработать логику по задаче #609,
   то этот лимит уже не будет влиять на возможные сбои крон команд. Однако этот лимит может как-то влиять на 
   работу очередей и если потребуется уменьшить нагрузку на очереди, то этот лимит нужно уменьшать



